# Snippets Benchmark
#
# Tests all snippets defined in resources/config/snippets.yaml
# Validates that snippet expansion and execution work correctly.
#
# Tool groups (each group is a single scenario with multiple tasks):
# - Package (pkg_*): Version checks for npm, pypi, models
# - OneTool (ot_*): Internal tools for find, namespace, status
# - Ripgrep (rg_*): Local code search (todos, definitions, counts)
# - Brave (brv_*): Brave Search (requires BRAVE_API_KEY)
# - Context7 (c7_*): Documentation lookup (requires CONTEXT7_API_KEY)
# - Google (g_*): Google grounding (requires GOOGLE_API_KEY)
# - GitHub (gh_*): GitHub search (requires GITHUB_TOKEN)
# - Web (web_*): Web fetch operations
# - Excel (xl_*): Excel file operations
# - LLM (llm_*): LLM transform operations
# - Code (c_*): Semantic code search (requires index)
# - Database (db_*): Database operations
#
# Use with: ot-bench run demo/bench/snippets.yaml
# Run specific tags: ot-bench run demo/bench/snippets.yaml --tags pkg

defaults:
  timeout: 60
  model: google/gemini-3-flash-preview

evaluators:
  # Package version results
  has_version:
    regex: "\\d+\\.\\d+"
    expect_match: true

  # Tool list output
  has_tools:
    regex: "name:\\s*[a-z]+\\.[a-z_]+"
    expect_match: true

  # Config output
  has_config:
    regex: "(aliases|snippets|servers):"
    expect_match: true

  # Health status
  has_health:
    regex: "status:\\s*ok"
    expect_match: true

  # Ripgrep results
  has_file_match:
    regex: "\\.(py|ts|js|yaml|md):"
    expect_match: true

  # Model search results
  has_model:
    regex: "(claude|gpt|gemini|llama)"
    expect_match: true

  # Search/research results
  has_content:
    regex: "\\w{10,}"
    expect_match: true

  # Excel success
  has_excel_success:
    regex: "(created|written|read|formula)"
    expect_match: true

servers:
  onetool:
    type: stdio
    command: uv
    args: ["run", "ot-serve"]
    env:
      OT_CWD: demo

scenarios:
  # =============================================================================
  # PACKAGE SNIPPETS (pkg_*) - No API key required
  # =============================================================================

  - name: "Snippet: Package"
    description: "Package version checks (npm, pypi, model search)"
    tasks:
      - name: "snippet:pkg:npm_single"
        server: onetool
        tags: [snippet, pkg, npm]
        evaluate: has_version
        prompt: |
          __ot
          ```
          $pkg_npm packages=react
          ```
          Return the version found.

      - name: "snippet:pkg:npm_multi"
        server: onetool
        tags: [snippet, pkg, npm]
        evaluate: has_version
        prompt: |
          __ot
          ```
          $pkg_npm packages="react, express, typescript"
          ```
          List all versions found.

      - name: "snippet:pkg:pypi_single"
        server: onetool
        tags: [snippet, pkg, pypi]
        evaluate: has_version
        prompt: |
          __ot
          ```
          $pkg_pypi packages=requests
          ```
          Return the version found.

      - name: "snippet:pkg:pypi_multi"
        server: onetool
        tags: [snippet, pkg, pypi]
        evaluate: has_version
        prompt: |
          __ot
          ```
          $pkg_pypi packages="requests, flask, fastapi"
          ```
          List all versions found.

      - name: "snippet:pkg:model_query"
        server: onetool
        tags: [snippet, pkg, model]
        evaluate: has_model
        prompt: |
          __ot
          ```
          $pkg_model query=claude
          ```
          List the models found.

      - name: "snippet:pkg:model_provider"
        server: onetool
        tags: [snippet, pkg, model]
        evaluate: has_model
        prompt: |
          __ot
          ```
          $pkg_model provider=anthropic
          ```
          List the models found.

  # =============================================================================
  # ONETOOL INTERNAL SNIPPETS (ot_*) - No API key required
  # =============================================================================

  - name: "Snippet: OneTool"
    description: "Internal OneTool operations (find, namespace, status)"
    tasks:
      - name: "snippet:ot:find_search"
        server: onetool
        tags: [snippet, ot, find]
        evaluate: has_tools
        prompt: |
          __ot
          ```
          $ot_find pattern=search
          ```
          Return the tool output exactly.

      - name: "snippet:ot:find_version"
        server: onetool
        tags: [snippet, ot, find]
        evaluate: has_tools
        prompt: |
          __ot
          ```
          $ot_find pattern=version
          ```
          Return the tool output exactly.

      - name: "snippet:ot:ns_package"
        server: onetool
        tags: [snippet, ot, ns]
        evaluate: has_tools
        prompt: |
          __ot
          ```
          $ot_ns ns=package
          ```
          Return the tool output exactly.

      - name: "snippet:ot:ns_ot"
        server: onetool
        tags: [snippet, ot, ns]
        evaluate: has_tools
        prompt: |
          __ot
          ```
          $ot_ns ns=ot
          ```
          Return the tool output exactly.

      - name: "snippet:ot:status"
        server: onetool
        tags: [snippet, ot, status]
        evaluate: has_health
        prompt: |
          __ot
          ```
          $ot_status
          ```
          Return the output exactly.

  # =============================================================================
  # RIPGREP SNIPPETS (rg_*) - Local search, no API key
  # =============================================================================

  - name: "Snippet: Ripgrep"
    description: "Local code search (todos, definitions, counts)"
    tasks:
      - name: "snippet:rg:todos_default"
        server: onetool
        tags: [snippet, rg, todos]
        evaluate:
          regex: "(TODO|FIXME|no matches)"
          expect_match: true
        prompt: |
          __ot
          ```
          $rg_todos
          ```
          Return any TODOs found or indicate none found.

      - name: "snippet:rg:todos_path"
        server: onetool
        tags: [snippet, rg, todos]
        evaluate:
          regex: "(TODO|FIXME|no matches)"
          expect_match: true
        prompt: |
          __ot
          ```
          $rg_todos path=src
          ```
          Return any TODOs found or indicate none found.

      - name: "snippet:rg:def_python"
        server: onetool
        tags: [snippet, rg, def]
        evaluate: has_file_match
        prompt: |
          __ot
          ```
          $rg_def name=foo lang=py
          ```
          Return matches found.

      - name: "snippet:rg:def_default"
        server: onetool
        tags: [snippet, rg, def]
        evaluate: has_file_match
        prompt: |
          __ot
          ```
          $rg_def name=bar
          ```
          Return matches found.

      - name: "snippet:rg:count_simple"
        server: onetool
        tags: [snippet, rg, count]
        evaluate:
          regex: "\\d+"
          expect_match: true
        prompt: |
          __ot
          ```
          $rg_count pattern="def "
          ```
          Return the count.

      - name: "snippet:rg:count_typed"
        server: onetool
        tags: [snippet, rg, count]
        evaluate:
          regex: "\\d+"
          expect_match: true
        prompt: |
          __ot
          ```
          $rg_count pattern=import file_type=py
          ```
          Return the count.

  # =============================================================================
  # BRAVE SEARCH SNIPPETS (brv_*) - Requires BRAVE_API_KEY
  # =============================================================================

  - name: "Snippet: Brave"
    description: "Brave Search (research, compare, news)"
    tasks:
      - name: "snippet:brv:research_default"
        server: onetool
        tags: [snippet, brv, research, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $brv_research topic="Python async best practices"
          ```
          Summarize the findings.

      - name: "snippet:brv:research_count"
        server: onetool
        tags: [snippet, brv, research, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $brv_research topic="FastAPI tutorials" count=3
          ```
          Summarize the findings.

      - name: "snippet:brv:compare"
        server: onetool
        tags: [snippet, brv, compare, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $brv_compare items="FastAPI, Flask"
          ```
          Compare the technologies.

      - name: "snippet:brv:news_default"
        server: onetool
        tags: [snippet, brv, news, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $brv_news topic=AI
          ```
          Summarize the news.

  # =============================================================================
  # CONTEXT7 SNIPPETS (c7_*) - Requires CONTEXT7_API_KEY
  # =============================================================================

  - name: "Snippet: Context7"
    description: "Library documentation lookup (search, docs, examples)"
    tasks:
      - name: "snippet:c7:search"
        server: onetool
        tags: [snippet, c7, search, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $c7_search query=fastapi
          ```
          Return the library keys found.

      - name: "snippet:c7:docs_simple"
        server: onetool
        tags: [snippet, c7, docs, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $c7_docs library="tiangolo/fastapi"
          ```
          Return the documentation summary.

      - name: "snippet:c7:docs_topic"
        server: onetool
        tags: [snippet, c7, docs, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $c7_docs library=facebook/react topic=hooks
          ```
          Return the documentation.

      - name: "snippet:c7:examples"
        server: onetool
        tags: [snippet, c7, examples, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $c7_examples library="tiangolo/fastapi" topic="dependency injection"
          ```
          Return the examples.

  # =============================================================================
  # GOOGLE GROUNDING SNIPPETS (g_*) - Requires GOOGLE_API_KEY
  # =============================================================================

  - name: "Snippet: Google"
    description: "Google grounding search (docs, debug, reddit)"
    tasks:
      - name: "snippet:g:docs_simple"
        server: onetool
        tags: [snippet, g, docs, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $g_docs query="async generators"
          ```
          Return the documentation.

      - name: "snippet:g:docs_tech"
        server: onetool
        tags: [snippet, g, docs, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $g_docs query=middleware tech=FastAPI
          ```
          Return the documentation.

      - name: "snippet:g:debug"
        server: onetool
        tags: [snippet, g, debug, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $g_debug error=ModuleNotFoundError tech=Python
          ```
          Return the solutions.

      - name: "snippet:g:reddit_simple"
        server: onetool
        tags: [snippet, g, reddit, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $g_reddit topic="best Python IDE"
          ```
          Return the discussions.

      - name: "snippet:g:reddit_subreddit"
        server: onetool
        tags: [snippet, g, reddit, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $g_reddit topic="FastAPI deployment" subreddit=Python
          ```
          Return the discussions.

  # =============================================================================
  # GITHUB SNIPPETS (gh_*) - Requires GITHUB_TOKEN
  # =============================================================================

  - name: "Snippet: GitHub"
    description: "GitHub search (repos, issues)"
    tasks:
      - name: "snippet:gh:repos_default"
        server: onetool
        tags: [snippet, gh, repos, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $gh_repos query="mcp server language:python"
          ```
          List the repositories found.

      - name: "snippet:gh:repos_sort"
        server: onetool
        tags: [snippet, gh, repos, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $gh_repos query="fastapi template" sort=updated
          ```
          List the repositories found.

      - name: "snippet:gh:issues"
        server: onetool
        tags: [snippet, gh, issues, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $gh_issues query="repo:anthropics/anthropic-sdk-python is:open"
          ```
          List the issues found.

  # =============================================================================
  # WEB FETCH SNIPPETS (web_*) - May require external access
  # =============================================================================

  - name: "Snippet: Web"
    description: "Web fetch operations (summary, extract)"
    tasks:
      - name: "snippet:web:summary_simple"
        server: onetool
        tags: [snippet, web, summary, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $web_summary url="https://docs.python.org/3/library/asyncio.html"
          ```
          Return the summary.

      - name: "snippet:web:summary_focus"
        server: onetool
        tags: [snippet, web, summary, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $web_summary url="https://fastapi.tiangolo.com/" focus=features
          ```
          Return the summary.

      - name: "snippet:web:extract"
        server: onetool
        tags: [snippet, web, extract, external]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $web_extract url="https://pypi.org/project/requests/" schema="name, version, description"
          ```
          Return the extracted data.

  # =============================================================================
  # EXCEL SNIPPETS (xl_*) - Local file operations
  # =============================================================================

  - name: "Snippet: Excel"
    description: "Excel file operations (new, read, write, sum)"
    tasks:
      - name: "snippet:xl:new"
        server: onetool
        tags: [snippet, xl, new]
        evaluate: has_excel_success
        prompt: |
          __ot
          ```
          $xl_new filepath="/tmp/test_snippet.xlsx" headers="Name, Value, Date"
          ```
          Confirm the file was created.

      - name: "snippet:xl:read"
        server: onetool
        tags: [snippet, xl, read]
        evaluate:
          regex: "(Name|Value|Date|empty|no data)"
          expect_match: true
        prompt: |
          __ot
          ```
          $xl_read filepath="/tmp/test_snippet.xlsx" range="A1:C1"
          ```
          Return the data read.

      - name: "snippet:xl:write"
        server: onetool
        tags: [snippet, xl, write]
        evaluate: has_excel_success
        prompt: |
          __ot
          ```
          $xl_write filepath="/tmp/test_snippet.xlsx" cell=A2 data="[[\"Test\", 100, \"2024-01-01\"]]"
          ```
          Confirm the write succeeded.

      - name: "snippet:xl:sum"
        server: onetool
        tags: [snippet, xl, sum]
        evaluate: has_excel_success
        prompt: |
          __ot
          ```
          $xl_sum filepath="/tmp/test_snippet.xlsx" column=B start_row=2 end_row=5
          ```
          Confirm the formula was added.

  # =============================================================================
  # LLM TRANSFORM SNIPPETS (llm_*) - Uses configured model
  # =============================================================================

  - name: "Snippet: LLM"
    description: "LLM transform operations (summary, extract, rewrite)"
    tasks:
      - name: "snippet:llm:summary_default"
        server: onetool
        tags: [snippet, llm, summary]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $llm_summary input="Python is a high-level, interpreted programming language known for its clear syntax and readability. It supports multiple programming paradigms including procedural, object-oriented, and functional programming. Python has a large standard library and an active community."
          ```
          Return the summary.

      - name: "snippet:llm:summary_short"
        server: onetool
        tags: [snippet, llm, summary]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $llm_summary input="FastAPI is a modern, fast web framework for building APIs with Python based on standard Python type hints. It offers automatic validation, serialization, and documentation." max_words=20
          ```
          Return the summary.

      - name: "snippet:llm:extract"
        server: onetool
        tags: [snippet, llm, extract]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $llm_extract input="Contact John Smith at john@example.com or call 555-1234" schema="name, email, phone"
          ```
          Return the extracted data.

      - name: "snippet:llm:rewrite_formal"
        server: onetool
        tags: [snippet, llm, rewrite]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $llm_rewrite input="Hey, this API is super cool and really fast!" style=formal
          ```
          Return the rewritten text.

      - name: "snippet:llm:rewrite_concise"
        server: onetool
        tags: [snippet, llm, rewrite]
        evaluate: has_content
        prompt: |
          __ot
          ```
          $llm_rewrite input="The implementation of the feature was completed successfully and all the tests passed without any failures or errors."
          ```
          Return the rewritten text.

  # =============================================================================
  # CODE SEARCH SNIPPETS (c_*) - Requires ChunkHound index
  # =============================================================================

  - name: "Snippet: Code"
    description: "Semantic code search"
    tasks:
      - name: "snippet:c:search"
        server: onetool
        tags: [snippet, c, search, external]
        evaluate:
          regex: "(result|match|found|error|not configured)"
          expect_match: true
        prompt: |
          __ot
          ```
          $c_search query="error handling" limit=3
          ```
          Return the results or indicate if not configured.

  # =============================================================================
  # DATABASE SNIPPETS (db_*) - Requires DB connection
  # =============================================================================

  - name: "Snippet: Database"
    description: "Database operations (explore, preview, count)"
    tasks:
      - name: "snippet:db:explore"
        server: onetool
        tags: [snippet, db, explore, external]
        evaluate:
          regex: "(table|error|connection|not configured)"
          expect_match: true
        prompt: |
          __ot
          ```
          $db_explore url="sqlite:///demo/db/northwind.db"
          ```
          List tables or indicate error.

      - name: "snippet:db:preview"
        server: onetool
        tags: [snippet, db, preview, external]
        evaluate:
          regex: "(row|data|error|connection|not found)"
          expect_match: true
        prompt: |
          __ot
          ```
          $db_preview url="sqlite:///demo/db/northwind.db" table=Orders limit=5
          ```
          Return preview or indicate error.

      - name: "snippet:db:count"
        server: onetool
        tags: [snippet, db, count, external]
        evaluate:
          regex: "(\\d+|error|connection|not found)"
          expect_match: true
        prompt: |
          __ot
          ```
          $db_count url="sqlite:///demo/db/northwind.db" table=Orders
          ```
          Return count or indicate error.
